import{p as re}from"./paginationMeta-DF6W6vpY.js";import{_ as de}from"./AppTextarea-D7ChMIYv.js";import{_ as ue}from"./DialogCloseBtn-DFQkjJSZ.js";import{_ as me}from"./AppTextField-CP55am0g.js";import{_ as pe}from"./AppAutocomplete-Dx7JPk9j.js";import{$ as ce}from"./api-N0CH2dad.js";import{r as n,bd as fe,dE as K,bi as ve,Y as q,E as ge,w as _e,bO as Ve,a as be,c as W,o as c,b as a,e as o,d as u,t as $,F as ye,h as ke,f as g,b1 as f,l as i,k as C,ah as _,s as m,_ as V,p as X,b8 as M}from"./main-BEYAFsWY.js";import{u as Z}from"./useApi-DL_wWqQ9.js";import{c as ee}from"./createUrl-CNJYluNR.js";import{_ as xe}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{V as P}from"./VCardText-BoDvIV3o.js";import{V as te,a as we}from"./VRow-DhucUJ_c.js";import{V as R}from"./VCard-DAB_Bu5L.js";import{V as D}from"./VDivider-CFXljG1d.js";import{V as $e}from"./VDataTableServer-BhPmqj1t.js";import{V as Ce}from"./VPagination-WiSBs5bf.js";import{V as Pe}from"./VDialog-BkOJSaE5.js";import{V as Te}from"./VSnackbar-ChDeThqV.js";import"./VTextarea-B7IpR3s5.js";import"./autofocus-sxRgyBjq.js";import"./VCounter-CG_HpDHy.js";import"./VField-9ku5YizL.js";import"./VTextField-Dp2G28tr.js";import"./VAutocomplete-BLVUhDue.js";import"./VSelect-BCqqkMkZ.js";import"./VList-BOjC5y0z.js";import"./ssrBoot-CAyz4zn7.js";import"./VAvatar-B5UblNHH.js";import"./VCheckboxBtn-Civ28FTj.js";import"./VSelectionControl-Dq5wMchr.js";import"./VChip-DQe73DDG.js";import"./VSlideGroup-CcoO5AYH.js";import"./filter-CZ8mmpcR.js";import"./index-CvOPxmL5.js";import"./VDataTable-BkrQF0Ii.js";import"./VTable-ldYwifqa.js";const Ee={class:"d-flex flex-wrap gap-4 mx-5"},Ae={class:"flex-grow-1"},Ue={class:"d-flex gap-4"},Se={class:"custom-loader"},he={class:"text-end"},Be={class:"d-flex align-center justify-space-between flex-wrap gap-3 pa-5 pt-3"},Ie={class:"text-sm text-medium-emphasis mb-0"},Le=["textContent"],qe={__name:"index",async setup(Me){let T,F;const b=n(null),y=n([]),E=n(8),d=n(1),N=n(0),p=n(!1),j=n(""),O=n(""),Q=n(""),z=n(),h=n(""),Y=n(!1),v=n(!1),k=n(""),A=n("success"),U=n({});fe("incidentData");const ae=[{title:"Titre",key:"title"},{title:"Date de l'incident",key:"occurred_at_fr"},{title:"Localisation",key:"location.name"},{key:"actions",title:"Actions",align:"end"}],s=K({filter:{title:"Filtres"},data:{title:{singular:"Incident",plural:"Incidents"},actions:{singular:"l'incident",plural:"les incidents"},rule:{name:"incident"},link:{base:"incident"},api:{endPoint:"incident",data:null,query:{}}}}),r=K([{view:{cols:{col:6,sm:6},name:{itemTitle:"full_name",itemValue:"id"}},base:{name:"Agent",data_source:"api",api_endpoint:"user",query:{paginate:"false",profile:"agent"}},filter:{key:"user_id",value:null},api:{datac:[]}},{view:{cols:{col:6,sm:6},name:{itemTitle:"name",itemValue:"id"}},base:{name:"Localisation",data_source:"api",api_endpoint:"location",query:{paginate:"false"}},filter:{key:"location_id",value:null},api:{datac:[]}}]),B={with_location:"true"};for(let l=0;l<r.length;l++)if(r[l].base.data_source==="api"){const{data:e,execute:w}=([T,F]=ve(()=>Z(ee(`/${r[l].base.api_endpoint}`,{query:r[l].base.query}))),T=await T,F(),T);r[l].api.data=e,r[l].api.execute=w,r[l].api.datac=r[l].api.data.data,B[r[l].filter.key]=r[l].filter.value}const S=n({data:[],total:0,lastPage:1}),x=async(l=[])=>{l.forEach(e=>{y.value[e]=!0});try{const{data:e}=await Z(ee(s.data.api.endPoint,{query:{search:b.value,page:d.value,...s.data.api.query,...B}}));S.value=e.value}finally{l.forEach(e=>{y.value[e]=!1})}},le=q(()=>S.value.data),G=q(()=>S.value.total),H=q(()=>S.value.lastPage),oe=l=>{d.value=l.page},ie=async l=>{U.value[l]=!0;try{const e=await ce(`${s.data.api.endPoint}/${l}`,{method:"DELETE"});if(e.status==200)v.value=!0,A.value="success",k.value=`${s.data.title.singular} supprimé avec succès`;else{A.value="error",v.value=!0,k.value="";for(const w in e.errors)e.errors[w].forEach(I=>{k.value+=""+I+"<br>"})}}catch{A.value="error",v.value=!0,k.value="Erreur lors de la suppression"}finally{U.value[l]=!1,await x()}};return ge(()=>{x([4])}),_e([b,d],async()=>{await x([4])}),Ve(async()=>{r.forEach(l=>{B[l.filter.key]=l.filter.value}),await x([4])}),(l,e)=>{const w=pe,I=me,L=be("IconBtn"),ne=ue,se=de;return c(),W("div",null,[a(R,{class:"mb-6"},{default:o(()=>[a(P,null,{default:o(()=>[a(te,null,{default:o(()=>[a(P,null,{default:o(()=>[u("h2",null,"Liste des "+$(s.data.title.plural),1)]),_:1})]),_:1})]),_:1})]),_:1}),a(R,{title:s.filter.title,class:"mb-6"},{default:o(()=>[a(P,null,{default:o(()=>[a(te,null,{default:o(()=>[(c(!0),W(ye,null,ke(r,t=>(c(),g(we,{key:t.filter.key,cols:t.view.cols.col,sm:t.view.cols.sm??6},{default:o(()=>[a(w,{modelValue:t.filter.value,"onUpdate:modelValue":J=>t.filter.value=J,placeholder:t.base.name,"item-title":t.view.name.itemTitle??"name","item-value":t.view.name.itemValue??"id",items:t.api.datac,clearable:"","clear-icon":"tabler-x"},null,8,["modelValue","onUpdate:modelValue","placeholder","item-title","item-value","items"])]),_:2},1032,["cols","sm"]))),128))]),_:1}),a(D,{class:"my-4"})]),_:1}),u("div",Ee,[u("div",Ae,[a(I,{modelValue:i(b),"onUpdate:modelValue":e[0]||(e[0]=t=>f(b)?b.value=t:null),placeholder:"Rechercher"},null,8,["modelValue"])]),u("div",Ue,[l.$can("create",s.data.rule.name)?(c(),g(_,{key:0,color:"primary","prepend-icon":"tabler-plus",to:{name:`${s.data.link.base}-add`}},{default:o(()=>[...e[11]||(e[11]=[m(" Nouveau ",-1)])]),_:1},8,["to"])):C("",!0),a(_,{loading:i(y)[3],disabled:i(y)[3],"prepend-icon":"tabler-refresh",onClick:e[1]||(e[1]=t=>x([3,4]))},{loader:o(()=>[u("span",Se,[a(V,{icon:"tabler-refresh"})])]),default:o(()=>[e[12]||(e[12]=m(" Recharger ",-1))]),_:1},8,["loading","disabled"])])]),a(D,{class:"mt-4"}),a($e,{"items-per-page":i(E),"onUpdate:itemsPerPage":e[3]||(e[3]=t=>f(E)?E.value=t:null),page:i(d),"onUpdate:page":e[4]||(e[4]=t=>f(d)?d.value=t:null),loading:i(y)[4],headers:ae,items:i(le),"items-length":i(G),class:"text-no-wrap","loading-text":"En cours de chargement","onUpdate:options":oe},{"item.actions":o(({item:t})=>[u("div",he,[u("div",null,[l.$can("read","incident")?(c(),g(L,{key:0,to:{name:`${s.data.link.base}-id`,params:{id:t.id}}},{default:o(()=>[a(M,{activator:"parent",transition:"scroll-x-transition",location:"top"},{default:o(()=>[...e[13]||(e[13]=[m(" Details ",-1)])]),_:1}),a(V,{icon:"tabler-eye"})]),_:1},8,["to"])):C("",!0),l.$can("edit","incident")?(c(),g(L,{key:1,to:{name:`${s.data.link.base}-edit-id`,params:{id:t.id}}},{default:o(()=>[a(M,{activator:"parent",transition:"scroll-x-transition",location:"top"},{default:o(()=>[...e[14]||(e[14]=[m(" Modifier ",-1)])]),_:1}),a(V,{icon:"tabler-edit"})]),_:1},8,["to"])):C("",!0),l.$can("delete","incident")?(c(),g(L,{key:2,loading:i(U)[t.id],disabled:i(U)[t.id],onClick:J=>{N.value=t.id,j.value=`Supprimer ${s.data.actions.singular}`,O.value=`Voulez vous vraiment supprimer ${s.data.actions.singular}?`,z.value=ie,Q.value="Supprimer",Y.value=!1,p.value=!0}},{default:o(()=>[a(V,{icon:"tabler-trash",color:"error"}),a(M,{activator:"parent",transition:"scroll-x-transition",location:"bottom"},{default:o(()=>[...e[15]||(e[15]=[m(" Supprimer ",-1)])]),_:1})]),_:1},8,["loading","disabled","onClick"])):C("",!0)])])]),bottom:o(()=>[a(D),u("div",Be,[u("p",Ie,$(("paginationMeta"in l?l.paginationMeta:i(re))({page:i(d),itemsPerPage:i(E)},i(G))),1),a(Ce,{modelValue:i(d),"onUpdate:modelValue":e[2]||(e[2]=t=>f(d)?d.value=t:null),length:i(H),"total-visible":l.$vuetify.display.xs?1:Math.min(i(H),5)},{prev:o(t=>[a(_,X({variant:"tonal",color:"default"},t,{icon:!1}),{default:o(()=>[a(V,{start:"",icon:"tabler-arrow-left"}),e[16]||(e[16]=m(" Précedent ",-1))]),_:1},16)]),next:o(t=>[a(_,X({variant:"tonal",color:"default"},t,{icon:!1}),{default:o(()=>[e[17]||(e[17]=m(" Suivant ",-1)),a(V,{end:"",icon:"tabler-arrow-right"})]),_:1},16)]),_:1},8,["modelValue","length","total-visible"])])]),_:1},8,["items-per-page","page","loading","items","items-length"])]),_:1},8,["title"]),a(Pe,{modelValue:i(p),"onUpdate:modelValue":e[9]||(e[9]=t=>f(p)?p.value=t:null),class:"v-dialog-sm"},{default:o(()=>[a(ne,{onClick:e[5]||(e[5]=t=>p.value=!i(p))}),a(R,{title:i(j)},{default:o(()=>[a(P,null,{default:o(()=>[m($(i(O))+" ",1),i(Y)?(c(),g(se,{key:0,modelValue:i(h),"onUpdate:modelValue":e[6]||(e[6]=t=>f(h)?h.value=t:null),class:"mt-3",label:"Commentaire",placeholder:"Ex: RAS"},null,8,["modelValue"])):C("",!0)]),_:1}),a(P,{class:"d-flex justify-end gap-3 flex-wrap"},{default:o(()=>[a(_,{color:"secondary",variant:"tonal",onClick:e[7]||(e[7]=t=>p.value=!1)},{default:o(()=>[...e[18]||(e[18]=[m(" Retour ",-1)])]),_:1}),a(_,{onClick:e[8]||(e[8]=t=>{i(z)(i(N)),p.value=!1})},{default:o(()=>[m($(i(Q)),1)]),_:1})]),_:1})]),_:1},8,["title"])]),_:1},8,["modelValue"]),a(Te,{modelValue:i(v),"onUpdate:modelValue":e[10]||(e[10]=t=>f(v)?v.value=t:null),transition:"scale-transition",location:"top end",color:i(A)},{default:o(()=>[u("div",{textContent:$(i(k))},null,8,Le)]),_:1},8,["modelValue","color"])])}}},yt=xe(qe,[["__scopeId","data-v-375a097b"]]);export{yt as default};

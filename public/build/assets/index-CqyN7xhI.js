import{p as re}from"./paginationMeta-DF6W6vpY.js";import{_ as de}from"./AppTextarea-Byp6ONd4.js";import{_ as ue}from"./DialogCloseBtn-D3xd3JNr.js";import{_ as pe}from"./AppTextField-Dhk438H7.js";import{_ as me}from"./AppAutocomplete-CWRtlt6e.js";import{$ as ce}from"./api-0WedtC8c.js";import{r as n,bd as fe,dE as K,bi as ve,Y as M,E as ge,w as Ve,bO as _e,a as be,c as W,o as m,b as a,e as o,d as p,t as C,F as ye,h as ke,f,b1 as v,l as i,k as _,ah as b,s as d,_ as g,p as X,b8 as I}from"./main-BZyHWxP-.js";import{u as Z}from"./useApi-CqDIhdYp.js";import{c as ee}from"./createUrl-RWZycZLg.js";import{_ as xe}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{V as P}from"./VCardText-CmyiQv4t.js";import{V as te,a as we}from"./VRow-B20rruVT.js";import{V as R}from"./VCard-BHQDPESW.js";import{V as D}from"./VDivider-CktbFQ7a.js";import{V as $e}from"./VDataTableServer-B8prfqHZ.js";import{V as Ce}from"./VPagination-BafHFDao.js";import{V as Pe}from"./VDialog-7WxpKhhh.js";import{V as Te}from"./VSnackbar-r55CRLic.js";import"./VTextarea-DciDp74g.js";import"./autofocus-DThxoTWr.js";import"./VCounter-D2PtsxdL.js";import"./VField-CoXLbqml.js";import"./VTextField-BzLGB-co.js";import"./VAutocomplete-akOlU6OV.js";import"./VSelect-CI_o2-A6.js";import"./VList-DbFeSWDW.js";import"./ssrBoot-DURCToRA.js";import"./VAvatar-8Zwc_tqP.js";import"./VCheckboxBtn-qZOqlrBl.js";import"./VSelectionControl-DwoCMlaG.js";import"./VChip-CeQObjZq.js";import"./VSlideGroup-CbdWe5cW.js";import"./filter-Da5uf3G2.js";import"./index-CvOPxmL5.js";import"./VDataTable-CLMWV4tH.js";import"./VTable-Bfxydk3f.js";const Ee={class:"d-flex flex-wrap gap-4 mx-5"},Ae={class:"flex-grow-1"},Ue={class:"d-flex gap-4"},Se={class:"custom-loader"},Be={class:"text-end"},Ie={class:"d-flex align-center justify-space-between flex-wrap gap-3 pa-5 pt-3"},he={class:"text-sm text-medium-emphasis mb-0"},Le=["textContent"],qe={__name:"index",async setup(Me){let T,F;const y=n(null),k=n([]),E=n(8),u=n(1),N=n(0),c=n(!1),j=n(""),O=n(""),Q=n(""),z=n(),h=n(""),Y=n(!1),V=n(!1),x=n(""),A=n("success"),U=n({});fe("incidentData");const ae=[{title:"Titre",key:"title"},{title:"Date de l'incident",key:"occurred_at_fr"},{title:"Localisation",key:"location.name"},{key:"actions",title:"Actions",align:"end"}],s=K({filter:{title:"Filtres"},data:{title:{singular:"Incident",plural:"Incidents"},actions:{singular:"l'incident",plural:"les incidents"},rule:{name:"incident"},link:{base:"incident"},api:{endPoint:"incident",data:null,query:{}}}}),r=K([{view:{cols:{col:6,sm:6},name:{itemTitle:"full_name",itemValue:"id"}},base:{name:"Agent",data_source:"api",api_endpoint:"user",query:{paginate:"false",profile:"agent"}},filter:{key:"user_id",value:null},api:{datac:[]}},{view:{cols:{col:6,sm:6},name:{itemTitle:"name",itemValue:"id"}},base:{name:"Localisation",data_source:"api",api_endpoint:"location",query:{paginate:"false"}},filter:{key:"location_id",value:null},api:{datac:[]}}]),L={with_location:"true"};for(let l=0;l<r.length;l++)if(r[l].base.data_source==="api"){const{data:e,execute:$}=([T,F]=ve(()=>Z(ee(`/${r[l].base.api_endpoint}`,{query:r[l].base.query}))),T=await T,F(),T);r[l].api.data=e,r[l].api.execute=$,r[l].api.datac=r[l].api.data.data,L[r[l].filter.key]=r[l].filter.value}const S=n({data:[],total:0,lastPage:1}),w=async(l=[])=>{l.forEach(e=>{k.value[e]=!0});try{const{data:e}=await Z(ee(s.data.api.endPoint,{query:{search:y.value,page:u.value,...s.data.api.query,...L}}));S.value=e.value}finally{l.forEach(e=>{k.value[e]=!1})}},le=M(()=>S.value.data),G=M(()=>S.value.total),H=M(()=>S.value.lastPage),oe=l=>{u.value=l.page},ie=async l=>{U.value[l]=!0;try{const e=await ce(`${s.data.api.endPoint}/${l}`,{method:"DELETE"});if(e.status==200)V.value=!0,A.value="success",x.value=`${s.data.title.singular} supprimé avec succès`;else{A.value="error",V.value=!0,x.value="";for(const $ in e.errors)e.errors[$].forEach(q=>{x.value+=""+q+"<br>"})}}catch{A.value="error",V.value=!0,x.value="Erreur lors de la suppression"}finally{U.value[l]=!1,await w()}};return ge(()=>{w([4])}),Ve([y,u],async()=>{await w([4])}),_e(async()=>{r.forEach(l=>{L[l.filter.key]=l.filter.value}),await w([4])}),(l,e)=>{const $=me,q=pe,B=be("IconBtn"),ne=ue,se=de;return m(),W("div",null,[a(R,{class:"mb-6"},{default:o(()=>[a(P,null,{default:o(()=>[a(te,null,{default:o(()=>[a(P,null,{default:o(()=>[p("h2",null,"Liste des "+C(s.data.title.plural),1)]),_:1})]),_:1})]),_:1})]),_:1}),a(R,{title:s.filter.title,class:"mb-6"},{default:o(()=>[a(P,null,{default:o(()=>[a(te,null,{default:o(()=>[(m(!0),W(ye,null,ke(r,t=>(m(),f(we,{key:t.filter.key,cols:t.view.cols.col,sm:t.view.cols.sm??6},{default:o(()=>[a($,{modelValue:t.filter.value,"onUpdate:modelValue":J=>t.filter.value=J,placeholder:t.base.name,"item-title":t.view.name.itemTitle??"name","item-value":t.view.name.itemValue??"id",items:t.api.datac,clearable:"","clear-icon":"tabler-x"},null,8,["modelValue","onUpdate:modelValue","placeholder","item-title","item-value","items"])]),_:2},1032,["cols","sm"]))),128))]),_:1}),a(D,{class:"my-4"})]),_:1}),p("div",Ee,[p("div",Ae,[a(q,{modelValue:i(y),"onUpdate:modelValue":e[0]||(e[0]=t=>v(y)?y.value=t:null),placeholder:"Rechercher"},null,8,["modelValue"])]),p("div",Ue,[l.$can("create",s.data.rule.name)?(m(),f(b,{key:0,color:"primary","prepend-icon":"tabler-plus",to:{name:`${s.data.link.base}-add`}},{default:o(()=>[...e[11]||(e[11]=[d(" Nouveau ",-1)])]),_:1},8,["to"])):_("",!0),a(b,{loading:i(k)[3],disabled:i(k)[3],"prepend-icon":"tabler-refresh",onClick:e[1]||(e[1]=t=>w([3,4]))},{loader:o(()=>[p("span",Se,[a(g,{icon:"tabler-refresh"})])]),default:o(()=>[e[12]||(e[12]=d(" Recharger ",-1))]),_:1},8,["loading","disabled"])])]),a(D,{class:"mt-4"}),a($e,{"items-per-page":i(E),"onUpdate:itemsPerPage":e[3]||(e[3]=t=>v(E)?E.value=t:null),page:i(u),"onUpdate:page":e[4]||(e[4]=t=>v(u)?u.value=t:null),loading:i(k)[4],headers:ae,items:i(le),"items-length":i(G),class:"text-no-wrap","loading-text":"En cours de chargement","onUpdate:options":oe},{"item.actions":o(({item:t})=>[p("div",Be,[p("div",null,[l.$can("read","incident")?(m(),f(B,{key:0,to:{name:`${s.data.link.base}-id`,params:{id:t.id}}},{default:o(()=>[a(I,{activator:"parent",transition:"scroll-x-transition",location:"top"},{default:o(()=>[...e[13]||(e[13]=[d(" Details ",-1)])]),_:1}),a(g,{icon:"tabler-eye"})]),_:1},8,["to"])):_("",!0),l.$can("download","incident")?(m(),f(B,{key:1,to:{name:`/api/incident/${t.id}/pdf`,params:{id:t.id}}},{default:o(()=>[a(I,{activator:"parent",transition:"scroll-x-transition",location:"top"},{default:o(()=>[...e[14]||(e[14]=[d("Télécharger",-1)])]),_:1}),a(g,{icon:"tabler-download"})]),_:1},8,["to"])):_("",!0),l.$can("edit","incident")?(m(),f(B,{key:2,to:{name:`${s.data.link.base}-edit-id`,params:{id:t.id}}},{default:o(()=>[a(I,{activator:"parent",transition:"scroll-x-transition",location:"top"},{default:o(()=>[...e[15]||(e[15]=[d(" Modifier ",-1)])]),_:1}),a(g,{icon:"tabler-edit"})]),_:1},8,["to"])):_("",!0),l.$can("delete","incident")?(m(),f(B,{key:3,loading:i(U)[t.id],disabled:i(U)[t.id],onClick:J=>{N.value=t.id,j.value=`Supprimer ${s.data.actions.singular}`,O.value=`Voulez vous vraiment supprimer ${s.data.actions.singular}?`,z.value=ie,Q.value="Supprimer",Y.value=!1,c.value=!0}},{default:o(()=>[a(g,{icon:"tabler-trash",color:"error"}),a(I,{activator:"parent",transition:"scroll-x-transition",location:"bottom"},{default:o(()=>[...e[16]||(e[16]=[d(" Supprimer ",-1)])]),_:1})]),_:1},8,["loading","disabled","onClick"])):_("",!0)])])]),bottom:o(()=>[a(D),p("div",Ie,[p("p",he,C(("paginationMeta"in l?l.paginationMeta:i(re))({page:i(u),itemsPerPage:i(E)},i(G))),1),a(Ce,{modelValue:i(u),"onUpdate:modelValue":e[2]||(e[2]=t=>v(u)?u.value=t:null),length:i(H),"total-visible":l.$vuetify.display.xs?1:Math.min(i(H),5)},{prev:o(t=>[a(b,X({variant:"tonal",color:"default"},t,{icon:!1}),{default:o(()=>[a(g,{start:"",icon:"tabler-arrow-left"}),e[17]||(e[17]=d(" Précedent ",-1))]),_:1},16)]),next:o(t=>[a(b,X({variant:"tonal",color:"default"},t,{icon:!1}),{default:o(()=>[e[18]||(e[18]=d(" Suivant ",-1)),a(g,{end:"",icon:"tabler-arrow-right"})]),_:1},16)]),_:1},8,["modelValue","length","total-visible"])])]),_:1},8,["items-per-page","page","loading","items","items-length"])]),_:1},8,["title"]),a(Pe,{modelValue:i(c),"onUpdate:modelValue":e[9]||(e[9]=t=>v(c)?c.value=t:null),class:"v-dialog-sm"},{default:o(()=>[a(ne,{onClick:e[5]||(e[5]=t=>c.value=!i(c))}),a(R,{title:i(j)},{default:o(()=>[a(P,null,{default:o(()=>[d(C(i(O))+" ",1),i(Y)?(m(),f(se,{key:0,modelValue:i(h),"onUpdate:modelValue":e[6]||(e[6]=t=>v(h)?h.value=t:null),class:"mt-3",label:"Commentaire",placeholder:"Ex: RAS"},null,8,["modelValue"])):_("",!0)]),_:1}),a(P,{class:"d-flex justify-end gap-3 flex-wrap"},{default:o(()=>[a(b,{color:"secondary",variant:"tonal",onClick:e[7]||(e[7]=t=>c.value=!1)},{default:o(()=>[...e[19]||(e[19]=[d(" Retour ",-1)])]),_:1}),a(b,{onClick:e[8]||(e[8]=t=>{i(z)(i(N)),c.value=!1})},{default:o(()=>[d(C(i(Q)),1)]),_:1})]),_:1})]),_:1},8,["title"])]),_:1},8,["modelValue"]),a(Te,{modelValue:i(V),"onUpdate:modelValue":e[10]||(e[10]=t=>v(V)?V.value=t:null),transition:"scale-transition",location:"top end",color:i(A)},{default:o(()=>[p("div",{textContent:C(i(x))},null,8,Le)]),_:1},8,["modelValue","color"])])}}},yt=xe(qe,[["__scopeId","data-v-9cc64440"]]);export{yt as default};

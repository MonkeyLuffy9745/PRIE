import{i as A,dE as g,bi as I,r as y,Y as z,c as S,o as k,d as r,b as s,t as m,e as o,f as U,k as O,F as R,h as H,s as V,_ as C,bg as Y,ah as F,ba as G,b7 as J}from"./main-BZyHWxP-.js";import{_ as K}from"./FieldRenderer-ClWx76-A.js";import{u as Q}from"./useApi-CqDIhdYp.js";import{c as W}from"./createUrl-RWZycZLg.js";import{$ as X}from"./api-0WedtC8c.js";import{_ as Z}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{V as j,a as x}from"./VRow-B20rruVT.js";import{V as E}from"./VCard-BHQDPESW.js";import{V as T}from"./VCardText-CmyiQv4t.js";import{V as ee}from"./VForm-BpUU7xqx.js";import{V as te}from"./VSnackbar-r55CRLic.js";import"./AppDateTimePicker-Bt5bw6tg.js";import"./VField-CoXLbqml.js";import"./TiptapEditor-DOeDfFDI.js";import"./index-C3nn1atq.js";import"./index-Dxkci4Dk.js";import"./VDivider-CktbFQ7a.js";import"./validators-DpYrMFzk.js";import"./helpers-DK5QwNv0.js";import"./VTextField-BzLGB-co.js";import"./autofocus-DThxoTWr.js";import"./VCounter-D2PtsxdL.js";import"./VTextarea-DciDp74g.js";import"./VAutocomplete-akOlU6OV.js";import"./VSelect-CI_o2-A6.js";import"./VList-DbFeSWDW.js";import"./ssrBoot-DURCToRA.js";import"./VAvatar-8Zwc_tqP.js";import"./VCheckboxBtn-qZOqlrBl.js";import"./VSelectionControl-DwoCMlaG.js";import"./VChip-CeQObjZq.js";import"./VSlideGroup-CbdWe5cW.js";import"./filter-Da5uf3G2.js";import"./VSwitch-DLSIbHZW.js";import"./VFileInput-B00mRcAE.js";import"./index-CvOPxmL5.js";const ae={class:"d-flex flex-wrap justify-start justify-sm-space-between gap-y-4 gap-x-6 mb-6"},se={class:"d-flex flex-column justify-center"},oe={class:"text-h4 font-weight-medium"},le={class:"d-flex justify-space-between align-center mb-2"},re={class:"text-sm text-medium-emphasis"},ie={class:"text-sm text-medium-emphasis"},ne={class:"text-center mt-1"},ue={class:"text-sm text-medium-emphasis"},ce={class:"d-flex flex-wrap justify-start justify-sm-space-between gap-y-4 gap-x-6 mb-6"},de={class:"d-flex gap-4 align-center flex-wrap"},me=["innerHTML"],pe={__name:"add",async setup(_e){let f,w;const L=A(),p={api:{endpoint:"incident",method:"POST"},back_route_name:"incident"},N={create:"créé avec succès",update:"modifié avec succès",delete:"supprimé avec succès"},b={upload:{network:"Erreur de connexion lors de l'upload",size:"Fichier trop volumineux",format:"Format de fichier non supporté"}},$={endpoints:{upload:`/${p.api.endpoint}/upload-chunk`,merge:`/${p.api.endpoint}/merge-chunks`,create:`/${p.api.endpoint}`},methods:{upload:"POST",merge:"POST",create:p.api.method}},P=(t,a)=>t.type==="file"&&a[t.value_key]?a[t.value_key].map(e=>e.includes("size")?b.upload.size:e.includes("format")||e.includes("extension")?b.upload.format:e):a[t.value_key],n=g({name:"Incident",back_name:"un",second_back_name:"incident",api:{is_loading:!1}}),i=g({isUploading:!1,progress:0,currentChunk:0,totalChunks:0,fileName:""}),l=g([{type:"text",label:"titre",value_key:"title",default_value:"incendie",errors:null,required:!0,cols:{cols:12,sm:6,md:6,lg:6}},{type:"lov",label:"Localisation",default_value:null,value_key:"location_id",errors:null,required:!0,cols:{cols:12,sm:6,md:6,lg:6},data:{list:{id:"id",name:"name",source:"api",api:{endpoint:"location",query:{},execute:null,data:null},items:[],multiple:!1}}},{type:"text",label:"Personnes impliquées",value_key:"people_involved",default_value:null,errors:null,required:!1,cols:{cols:12,sm:12,md:12,lg:12}},{type:"date",label:"Date de l'incident",value_key:"occurred_at",default_value:null,errors:null,required:!0,cols:{cols:12,sm:12,md:12,lg:12}},{type:"textarea",label:"Description",value_key:"description",errors:null,required:!0,default_value:"test",cols:{cols:12,sm:12,md:12,lg:12}},{type:"textarea",label:"Actions prises",value_key:"actions_taken",errors:null,required:!1,default_value:"test",cols:{cols:12,sm:12,md:12,lg:12}}]),v=g(l.reduce((t,a)=>("default_value"in a?t[a.value_key]=a.default_value??null:t[a.value_key]=null,t),{}));for(let t=0;t<l.length;t++)if(l[t].type==="lov"&&l[t].data.list.source==="api"){const{data:a,execute:e}=([f,w]=I(()=>Q(W(`/${l[t].data.list.api.endpoint}`,{query:l[t].data.list.api.query}))),f=await f,w(),f);l[t].data.list.api.data=a,l[t].data.list.api.execute=e,l[t].data.list.items=l[t].data.list.api.data.data}function q(){l.forEach(t=>{t.errors=null})}function D(){i.isUploading=!1,i.progress=0,i.currentChunk=0,i.totalChunks=0,i.fileName=""}const h=y(),M=()=>{h.value?.validate().then(async({valid:t})=>{if(n.api.is_loading=!0,t){try{const a={...v};q();const e=await X($.endpoints.create,{method:$.methods.create,body:a});if(e?.status==201)c.value=`${n.name} ${N.create}`,_.value="success",d.value=!0,L.push({name:p.back_route_name});else if(e?.errors){for(const u of l)e.errors[u.value_key]&&(u.errors=P(u,e.errors));c.value="";for(const u in e.errors)e.errors[u]&&(c.value+=`${e.errors[u]}`);_.value="error",d.value=!!c.value}else c.value=e?.message??"Une erreur inconnue est survenue.",_.value="error",d.value=!0}catch(a){q(),D(),c.value=a.message??b.upload.network,_.value="error",d.value=!0}J(()=>{h.value?.resetValidation()})}n.api.is_loading=!1})},d=y(!1),c=y(""),_=y("success"),B=z(()=>l.filter(t=>!t.active||t.active()));return(t,a)=>(k(),S("div",null,[r("div",ae,[r("div",se,[r("h4",oe," Ajouter "+m(n.back_name)+" "+m(n.name),1)])]),s(ee,{ref_key:"refForm",ref:h,onSubmit:G(M,["prevent"])},{default:o(()=>[s(j,null,{default:o(()=>[s(x,{md:"12"},{default:o(()=>[s(E,{class:"mb-6",title:`Informations sur ${n.second_back_name} ${n.name}`},{default:o(()=>[s(T,null,{default:o(()=>[s(j,null,{default:o(()=>[(k(!0),S(R,null,H(B.value,e=>(k(),U(x,{key:e.value_key,cols:(e.getCols?e.getCols():e.cols).cols??12,sm:(e.getCols?e.getCols():e.cols).sm??12,md:(e.getCols?e.getCols():e.cols).md??12,lg:(e.getCols?e.getCols():e.cols).lg??12},{default:o(()=>[s(K,{modelValue:v[e.value_key],"onUpdate:modelValue":u=>v[e.value_key]=u,field:e,context:{type:v.type}},null,8,["modelValue","onUpdate:modelValue","field","context"])]),_:2},1032,["cols","sm","md","lg"]))),128))]),_:1})]),_:1})]),_:1},8,["title"])]),_:1}),i.isUploading?(k(),U(x,{key:0,cols:"12"},{default:o(()=>[s(E,null,{default:o(()=>[s(T,null,{default:o(()=>[r("div",le,[r("span",re,[s(C,{icon:"tabler-upload",class:"me-2"}),V(" Upload en cours: "+m(i.fileName),1)]),r("span",ie,m(i.currentChunk)+"/"+m(i.totalChunks)+" chunks ",1)]),s(Y,{"model-value":i.progress,color:"primary",height:"8",rounded:"",striped:""},null,8,["model-value"]),r("div",ne,[r("span",ue,m(i.progress)+"% ",1)])]),_:1})]),_:1})]),_:1})):O("",!0),s(x,{cols:"12"},{default:o(()=>[r("div",ce,[a[3]||(a[3]=r("div",{class:"d-flex flex-column justify-center"},null,-1)),r("div",de,[s(F,{type:"reset",variant:"tonal",color:"primary"},{default:o(()=>[s(C,{start:"",icon:"tabler-circle-minus"}),a[1]||(a[1]=V(" Effacer ",-1))]),_:1}),s(F,{type:"submit",loading:n.api.is_loading,disabled:n.api.is_loading,class:"me-3"},{default:o(()=>[a[2]||(a[2]=V(" Enregistrer ",-1)),s(C,{end:"",icon:"tabler-checkbox"})]),_:1},8,["loading","disabled"])])])]),_:1})]),_:1})]),_:1},512),s(te,{modelValue:d.value,"onUpdate:modelValue":a[0]||(a[0]=e=>d.value=e),transition:"scale-transition",location:"top end",color:_.value},{default:o(()=>[r("div",{innerHTML:c.value},null,8,me)]),_:1},8,["modelValue","color"])]))}},We=Z(pe,[["__scopeId","data-v-0737ee5e"]]);export{We as default};
